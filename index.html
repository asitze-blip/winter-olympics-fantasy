<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Winter Olympics Fantasy League</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-bounce { animation: bounce 2s infinite; }
        .animate-pulse { animation: pulse 2s infinite; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAdOaJoUJx8N_OVnp9vZxFyYfx8s4G1MLk",
            authDomain: "winter-olympics-fantasy-app.firebaseapp.com",
            projectId: "winter-olympics-fantasy-app",
            storageBucket: "winter-olympics-fantasy-app.firebasestorage.app",
            messagingSenderId: "713102154905",
            appId: "1:713102154905:web:2b40ca72a9b3002171ec08"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        let EVENTS = []; //will be populated from Google Sheets

const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRpvFjZLOycMbDSRsFrUi7BbPvhH4yldpxR9ve3AXpxzJLtcVwO0WVYjRb_7v8kyHUFm5CpkMB9ZI5N/pub?output=csv';

// Function to get today's date in YYYY-MM-DD format (CET timezone)
function getTodayDateCET() {
    const now = new Date();
    // Convert to CET (UTC+1)
    const cetOffset = 1 * 60; // CET is UTC+1
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const cetTime = new Date(utc + (cetOffset * 60000));
    
    const year = cetTime.getFullYear();
    const month = String(cetTime.getMonth() + 1).padStart(2, '0');
    const day = String(cetTime.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}

// Function to fetch and parse events from Google Sheets

async function fetchEventsFromSheet() {
    try {
        console.log('Fetching events from Google Sheets...');
        
        const response = await fetch(GOOGLE_SHEETS_CSV_URL);
        const csvText = await response.text();
        
        console.log('CSV fetched, parsing...');
        
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        const events = [];
        const todayDate = getTodayDateCET();
        
        console.log('Today\'s date (CET):', todayDate);
        
        for (let i = 1; i < lines.length; i++) {
            const values = parseCSVLine(lines[i]);
            const row = {};
            
            headers.forEach((header, index) => {
                row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
            });
            
            // Only show TODAY's events (for voting)
const eventDate = row.Date.split('T')[0]; // Extract just the date part (YYYY-MM-DD)
if (eventDate !== '2026-02-07') {
    continue;
}
            
            if (!row.Event) {
                continue;
            }
            
            const isTeamEvent = row.IsTeamEvent === 'TRUE' || row.IsTeamEvent === 'True' || row.IsTeamEvent === '1';
            
            // Build contenders array
            const contenders = [];
            
            if (isTeamEvent) {
                for (let j = 1; j <= 5; j++) {
                    const country = row[`Top${j}`];
                    if (country && country.trim()) {
                        contenders.push({
                            name: country,
                            country: country
                        });
                    }
                }
            } else {
                for (let j = 1; j <= 5; j++) {
                    const name = row[`Top${j} Name`];
                    const country = row[`Top${j} Country`];
                    if (name && name.trim()) {
                        contenders.push({
                            name: name,
                            country: country || ''
                        });
                    }
                }
            }
            
            if (contenders.length > 0) {
                const eventName = `${row.Gender ? row.Gender + "'s " : ''}${row.Event}`;
                
                // NEW: Check if results are available
                const hasResults = row['Results Updated'] === 'TRUE' || row['Results Updated'] === 'True';
                
                events.push({
                    event: eventName,
                    sport: row.Sport,
                    venue: row.Venue,
                    time: row.Date,
                    isTeamEvent: isTeamEvent,
                    contenders: contenders,
                    // NEW: Add results if available
                    hasResults: hasResults,
                    goldWinner: hasResults ? row['Gold Winner'] : null,
                    silverWinner: hasResults ? row['Silver Winner'] : null,
                    bronzeWinner: hasResults ? row['Bronze Winner'] : null
                });
            }
        }
        
        console.log(`Found ${events.length} events for today`);
        
        // NEW: Also fetch ALL events with results for scoring
        await fetchAllResultsForScoring(lines, headers);
        
        return events;
        
    } catch (error) {
        console.error('Error fetching events from Google Sheets:', error);
        return [];
    }
}

// NEW: Fetch all completed events (not just today) for scoring purposes
async function fetchAllResultsForScoring(lines, headers) {
    console.log('Fetching all results for scoring...');
    
    window.ALL_RESULTS = {}; // Store globally for scoring
    
    for (let i = 1; i < lines.length; i++) {
        const values = parseCSVLine(lines[i]);
        const row = {};
        
        headers.forEach((header, index) => {
            row[header] = values[index] ? values[index].trim().replace(/"/g, '') : '';
        });
        
        const hasResults = row['Results Updated'] === 'TRUE' || row['Results Updated'] === 'True';
        
        if (hasResults && row.Event) {
            const eventName = `${row.Gender ? row.Gender + "'s " : ''}${row.Event}`;
            
            window.ALL_RESULTS[eventName] = {
                gold: row['Gold Winner'],
                silver: row['Silver Winner'],
                bronze: row['Bronze Winner']
            };
        }
    }
    
    console.log(`Loaded results for ${Object.keys(window.ALL_RESULTS).length} events`);
    
    // Recalculate all scores
    recalculateScores();
}

// NEW: Recalculate all user scores based on results
function recalculateScores() {
    console.log('Recalculating all scores...');
    
    const newScores = {};
    
    // For each user
    for (const username in state.userPicks) {
        let totalScore = 0;
        const userPicks = state.userPicks[username];
        
        // Check each of their picks
        for (const eventName in userPicks) {
            const pick = userPicks[eventName];
            const results = window.ALL_RESULTS[eventName];
            
            if (results) {
                // Award points based on medal
                if (pick === results.gold) {
                    totalScore += 3;
                } else if (pick === results.silver) {
                    totalScore += 2;
                } else if (pick === results.bronze) {
                    totalScore += 1;
                }
            }
        }
        
        newScores[username] = totalScore;
    }
    
    // Update scores
    state.allUserScores = newScores;
    saveData();
    
    console.log('Scores recalculated:', newScores);
}

// NEW: Get user's medal breakdown
function getUserMedals() {
    if (!state.currentUser) return { gold: [], silver: [], bronze: [] };
    
    const medals = { gold: [], silver: [], bronze: [] };
    const userPicks = state.userPicks[state.currentUser] || {};
    
    for (const eventName in userPicks) {
        const pick = userPicks[eventName];
        const results = window.ALL_RESULTS[eventName];
        
        if (results) {
            if (pick === results.gold) {
                medals.gold.push(eventName);
            } else if (pick === results.silver) {
                medals.silver.push(eventName);
            } else if (pick === results.bronze) {
                medals.bronze.push(eventName);
            }
        }
    }
    
    return medals;
}

// ADD this to your Stats tab rendering (in renderTabContent function)

// Helper function to parse a CSV line (handles commas inside quotes)
function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current);
            current = '';
        } else {
            current += char;
        }
    }
    
    result.push(current);
    return result;
}

// Add this function to load events when the app starts
async function loadEvents() {
    console.log('Loading events from Google Sheets...');
    EVENTS = await fetchEventsFromSheet();
    
    if (EVENTS.length === 0) {
        console.warn('No events found for today, using sample data');
        // Optionally fall back to EVENTS or show a message
    }
    
    // Re-render the app with new events
    if (state.currentUser && state.activeTab === 'events') {
        renderTabContent();
    }
}

// Call this when the app loads (add to your existing initialization code)
// Replace: const EVENTS = [...];
// With: Just declare it empty and call loadEvents()

// USAGE IN YOUR APP:
// 1. Replace all references to EVENTS with EVENTS
// 2. Call loadEvents() when the app starts
// 3. Add a "Refresh Events" button that calls loadEvents() again
        const MULTIPLIER_DAYS = {
            "2026-02-10": { name: "Opening Day Bonanza", multiplier: 2 }
        };

        const BADGE_DEFINITIONS = [
            { id: 'first_pick', name: 'First Pick', icon: 'üéØ', description: 'Made your first prediction' },
            { id: 'early_bird', name: 'Early Bird', icon: 'üê¶', description: 'Made picks for all events before first one started' },
            { id: 'century_club', name: 'Century Club', icon: 'üí∞', description: 'Reached 100 points' }
        ];

        // App State
        let state = {
            currentUser: null,
            usernameInput: '',
            activeTab: 'events',
            userPicks: {},
            allUserScores: {},
            userBadges: {},
            currentTime: new Date(),
            showDataInfo: true,
            eventAnalyses: {}
        };
        // Firebase storage - shared across all users!
        const storage = {
            async get(key) {
                try {
                    const doc = await db.collection('gameData').doc(key).get();
                    return doc.exists ? doc.data().value : {};
                } catch (error) {
                    console.log('Firebase read failed:', error);
                    return {};
                }
            },
            async set(key, value) {
                try {
                    await db.collection('gameData').doc(key).set({ value: value });
                } catch (error) {
                    console.log('Firebase write failed:', error);
                }
            }
        };
        async function loadData() {
            state.userPicks = await storage.get('picks');
            state.allUserScores = await storage.get('scores');
            state.userBadges = await storage.get('badges')
        }

        async function saveData() {
            await storage.set('picks', state.userPicks);
            await storage.set('scores', state.allUserScores);
            await storage.set('badges', state.userBadges);
        }
async function analyzeEvent(event) {
            const contenders = event.contenders.map(c => `${c.name} (${c.country})`).join(', ');
            
            try {
                const response = await fetch('/.netlify/functions/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        eventName: event.event,
                        contenders: contenders
                    })
                });

                const data = await response.json();
                return data.analysis || 'Unable to generate analysis.';
            } catch (error) {
                console.error('Analysis error:', error);
                return 'Unable to generate analysis at this time.';
            }
        }

        async function handleAnalyze(eventName) {
            console.log('=== ANALYZE CLICKED ===');
            console.log('Event name:', eventName);
            
            const event = EVENTS.find(e => e.event === eventName);
            console.log('Found event:', event);
            
            if (!event) {
                console.error('‚ùå EVENT NOT FOUND!');
                return;
            }
            
            // Set loading state in state object
            state.eventAnalyses[eventName] = { loading: true, text: '' };
            render();
            
            console.log('Calling analyzeEvent...');
            
            // Get analysis
            const analysis = await analyzeEvent(event);
            console.log('Analysis received:', analysis);
            
            // Store result in state
            state.eventAnalyses[eventName] = { loading: false, text: analysis };
            render();
            
            console.log('‚úÖ Analysis stored and rendered');
        }   
        function checkBadges() {
            if (!state.currentUser) return;
            
            const newBadges = {...(state.userBadges[state.currentUser] || {})};
            const userPickCount = Object.keys(state.userPicks[state.currentUser] || {}).length;
            
            if (userPickCount >= 1 && !newBadges.first_pick) {
                newBadges.first_pick = true;
            }
            
            if (userPickCount === EVENTS.length && !newBadges.early_bird) {
                newBadges.early_bird = true;
            }
            
            if ((state.allUserScores[state.currentUser] || 0) >= 100 && !newBadges.century_club) {
                newBadges.century_club = true;
            }
            
            state.userBadges[state.currentUser] = newBadges;
            saveData();
        }

        function isEventLocked(event) {
            const eventTime = new Date(event.time);
            const lockTime = new Date(eventTime.getTime() - 5 * 60000);
            return state.currentTime >= lockTime;
        }

        function getTimeUntilEvent(eventTime) {
            const diff = new Date(eventTime) - state.currentTime;
            if (diff < 0) return 'Event ended';
            
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        }

        function getPickDistribution(event) {
            const picks = {};
            Object.values(state.userPicks).forEach(userPicksObj => {
                const pick = userPicksObj[event.event];
                if (pick) picks[pick] = (picks[pick] || 0) + 1;
            });
            
            const total = Object.values(picks).reduce((sum, count) => sum + count, 0);
            return event.contenders.map(c => ({
                ...c,
                pickCount: picks[c.name] || 0,
                percentage: total > 0 ? Math.round((picks[c.name] || 0) / total * 100) : 0
            }));
        }

        function getUserStats() {
            if (!state.currentUser) return null;
            const picks = state.userPicks[state.currentUser] || {};
            const totalPicks = Object.keys(picks).length;
            const score = state.allUserScores[state.currentUser] || 0;
            const badges = Object.keys(state.userBadges[state.currentUser] || {}).filter(b => state.userBadges[state.currentUser][b]);
            
            return { totalPicks, score, badgeCount: badges.length };
        }

        function handleSignIn() {
            if (state.usernameInput.trim()) {
                state.currentUser = state.usernameInput.trim();
                if (!state.allUserScores[state.currentUser]) {
                    state.allUserScores[state.currentUser] = 0;
                    saveData();
                }
                render();
            }
        }

        function handleMakePick(eventName, contenderName) {
            const event = EVENTS.find(e => e.event === eventName);
            if (isEventLocked(event)) return;
            
            if (!state.userPicks[state.currentUser]) {
                state.userPicks[state.currentUser] = {};
            }
            state.userPicks[state.currentUser][eventName] = contenderName;
            saveData();
            checkBadges();
            render();
        }

        function render() {
            const app = document.getElementById('app');
            
            if (!state.currentUser) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center p-4">
                        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full transform transition-all duration-300">
                            <div class="text-center mb-6">
                                <div class="inline-block p-4 bg-yellow-100 rounded-full mb-4 animate-bounce">
                                    <svg class="w-16 h-16 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"></path>
                                    </svg>
                                </div>
                                <h1 class="text-3xl font-bold text-gray-800 mb-2">Winter Olympics</h1>
                                <h2 class="text-xl text-gray-600 mb-2">Fantasy League</h2>
                            </div>
                            
                            <div class="space-y-4">
                                <input
                                    type="text"
                                    id="usernameInput"
                                    value="${state.usernameInput}"
                                    placeholder="Choose your username"
                                    class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-lg transition-all"
                                />
                                <button
                                    onclick="handleSignIn()"
                                    class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all transform hover:scale-102"
                                >
                                    Join the League
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const input = document.getElementById('usernameInput');
                input.addEventListener('input', (e) => {
                    state.usernameInput = e.target.value;
                });
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSignIn();
                });
                return;
            }

            // Main app view
            const stats = getUserStats();
            const multiplier = MULTIPLIER_DAYS["2026-02-10"];
            
            app.innerHTML = `
                <div class="min-h-screen bg-gray-100">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-4 shadow-lg sticky top-0 z-50">
                        <div class="max-w-4xl mx-auto">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <h1 class="text-xl md:text-2xl font-bold">Winter Olympics Fantasy</h1>
                                    <p class="text-blue-100 text-sm md:text-base">Welcome, ${state.currentUser}!</p>
                                </div>
                                <button
                                    onclick="state.currentUser = null; render();"
                                    class="bg-white/20 px-3 py-1.5 md:px-4 md:py-2 rounded hover:bg-white/30 transition text-sm md:text-base"
                                >
                                    Sign Out
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 mt-3 text-center">
                                <div class="bg-white/10 rounded-lg p-2">
                                    <div class="text-lg md:text-2xl font-bold">${stats.score}</div>
                                    <div class="text-xs text-blue-100">Points</div>
                                </div>
                                <div class="bg-white/10 rounded-lg p-2">
                                    <div class="text-lg md:text-2xl font-bold">${stats.totalPicks}</div>
                                    <div class="text-xs text-blue-100">Picks</div>
                                </div>
                                <div class="bg-white/10 rounded-lg p-2">
                                    <div class="text-lg md:text-2xl font-bold">${stats.badgeCount}</div>
                                    <div class="text-xs text-blue-100">Badges</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    ${multiplier ? `
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white py-2 px-4 text-center animate-pulse">
                        ‚ö° <strong>${multiplier.name}</strong> - All points √ó${multiplier.multiplier} today!
                    </div>
                    ` : ''}

                    <!-- Tabs -->
                    <div class="bg-white shadow sticky top-16 md:top-20 z-40">
                        <div class="max-w-4xl mx-auto flex">
                            <button onclick="state.activeTab = 'events'; render();" 
                                class="flex-1 py-3 md:py-4 font-semibold transition-all text-sm md:text-base ${state.activeTab === 'events' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                                üìã Events
                            </button>
                            <button onclick="state.activeTab = 'leaderboard'; render();"
                                class="flex-1 py-3 md:py-4 font-semibold transition-all text-sm md:text-base ${state.activeTab === 'leaderboard' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                                üë• Leaderboard
                            </button>
                            <button onclick="state.activeTab = 'stats'; render();"
                                class="flex-1 py-3 md:py-4 font-semibold transition-all text-sm md:text-base ${state.activeTab === 'stats' ? 'bg-blue-600 text-white' : 'text-gray-600 hover:bg-gray-100'}">
                                üìä Stats
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="max-w-4xl mx-auto p-3 md:p-4">
                        ${state.showDataInfo ? `
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-3 md:p-4 mb-4 rounded animate-fade-in">
                            <div class="flex justify-between items-start">
                                <p class="text-xs md:text-sm text-yellow-800">
                                </p>
                                <button onclick="state.showDataInfo = false; render();" class="text-yellow-600 hover:text-yellow-800 ml-2">‚úï</button>
                            </div>
                        </div>
                        ` : ''}

                        <div id="tabContent"></div>
                    </div>
                </div>
            `;
        }
  function renderTabContent() {
    const content = document.getElementById('tabContent');
    
    if (state.activeTab === 'events') {
        content.innerHTML = `
            <div class="space-y-3 md:space-y-4">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800">Medal Events</h2>
                ${EVENTS.map((event, idx) => {
                    const locked = isEventLocked(event);
                    const distribution = getPickDistribution(event);
                    const userPick = state.userPicks[state.currentUser]?.[event.event];
                    
                    return `
                        <div class="bg-white rounded-lg shadow p-4 md:p-6 transition-all duration-300">
                            <div class="flex flex-col md:flex-row md:justify-between md:items-start mb-4 gap-2">
                                <div class="flex-1">
                                    <h3 class="text-lg md:text-xl font-bold text-gray-800">${event.event}</h3>
                                    <div class="flex items-center gap-2 mt-1 text-sm text-gray-500">
                                        üïê <span>${getTimeUntilEvent(event.time)}</span>
                                        ${locked ? 'üîí' : ''}
                                    </div>
                                </div>
                                <button
                                    id="analyze-btn-${event.event}"
                                    onclick="handleAnalyze(\`${event.event}\`)"
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 transition whitespace-nowrap"
                                >
                                    ü§ñ Analyze
                                </button>
                                <div class="flex gap-2">
                                    ${userPick ? '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs md:text-sm font-semibold whitespace-nowrap">‚úì Picked</span>' : ''}
                                    ${locked ? '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs md:text-sm font-semibold whitespace-nowrap">üîí Locked</span>' : ''}
                                </div>
                            </div>

                            <p class="text-xs md:text-sm font-semibold text-gray-600 mb-3">Top 5 Contenders:</p>
                            <div class="space-y-2">
                                ${distribution.map(contender => {
                                    const isSelected = state.userPicks[state.currentUser]?.[event.event] === contender.name;
                                    return `
                                        <button
                                            onclick="handleMakePick(\`${event.event}\`, \`${contender.name}\`)"
                                            ${locked ? 'disabled' : ''}
                                            class="w-full text-left p-3 rounded-lg border-2 transition-all duration-200 ${
                                                isSelected ? 'border-blue-500 bg-blue-50' :
                                                locked ? 'border-gray-200 bg-gray-50' :
                                                'border-gray-200 hover:border-blue-300 hover:bg-gray-50'
                                            }"
                                        >
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <span class="font-semibold text-sm md:text-base">${contender.name}</span>
                                                    <span class="text-gray-500 ml-2 text-xs md:text-sm">(${contender.country})</span>
                                                </div>
                                                ${userPick && contender.pickCount > 0 ? `<div class="text-xs md:text-sm text-gray-500">${contender.percentage}% picked</div>` : ''}
                                            </div>
                                            ${userPick && contender.pickCount > 0 ? `
                                                <div class="mt-2 bg-gray-200 rounded-full h-1.5 overflow-hidden">
                                                    <div class="bg-blue-500 h-full transition-all duration-500" style="width: ${contender.percentage}%"></div>
                                                </div>
                                            ` : ''}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                            <div id="analysis-${event.event}" class="mt-4 p-3 bg-purple-50 rounded-lg border border-purple-200 min-h-20">${state.eventAnalyses[event.event]?.loading ? '<p class="text-gray-500 italic">Generating analysis...</p>' : state.eventAnalyses[event.event]?.text ? `<p class="text-gray-700">${state.eventAnalyses[event.event].text}</p>` : ''}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    } else if (state.activeTab === 'leaderboard') {
        const sortedUsers = Object.entries(state.allUserScores).sort(([,a], [,b]) => b - a);
        content.innerHTML = `
            <div class="bg-white rounded-lg shadow p-4 md:p-6">
                <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Leaderboard</h2>
                ${sortedUsers.length === 0 ? 
                    '<p class="text-gray-500 text-center py-8 text-sm md:text-base">No players yet. Be the first to make a pick!</p>' :
                    `<div class="space-y-2">
                        ${sortedUsers.map(([username, score], idx) => `
                            <div class="flex justify-between items-center p-3 md:p-4 rounded-lg transition-all duration-300 ${
                                username === state.currentUser ? 'bg-blue-50 border-2 border-blue-500' : 'bg-gray-50'
                            }">
                                <div class="flex items-center gap-2 md:gap-3">
                                    <span class="text-xl md:text-2xl font-bold text-gray-400">#${idx + 1}</span>
                                    <span class="font-semibold text-gray-800 text-sm md:text-base">${username}</span>
                                    ${username === state.currentUser ? '<span class="text-blue-600 text-xs md:text-sm">(You)</span>' : ''}
                                </div>
                                <div class="text-xl md:text-2xl font-bold text-blue-600">${score}</div>
                            </div>
                        `).join('')}
                    </div>`
                }
            </div>
        `;
    } else if (state.activeTab === 'stats') {
        const stats = getUserStats();
        const medals = getUserMedals();
        const userBadges = state.userBadges[state.currentUser] || {};
        
        content.innerHTML = `
            <div class="space-y-4">
                <div class="bg-white rounded-lg shadow p-4 md:p-6">
                    <h2 class="text-xl md:text-2xl font-bold text-gray-800 mb-4">Your Statistics</h2>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-2xl md:text-3xl font-bold text-blue-600">${stats.totalPicks}</div>
                            <div class="text-xs md:text-sm text-gray-600">Total Picks</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-2xl md:text-3xl font-bold text-green-600">${stats.score}</div>
                            <div class="text-xs md:text-sm text-gray-600">Total Points</div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4 mb-6">
                        <h3 class="font-semibold text-gray-800 mb-3">üèÖ Your Medals</h3>
                        ${(medals.gold.length + medals.silver.length + medals.bronze.length === 0) ? 
                            '<p class="text-gray-500 text-sm italic">No medals yet. Results will appear here after events are completed!</p>' 
                            : 
                            (medals.gold.length > 0 ? `
                                <div class="mb-3">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-2xl">ü•á</span>
                                        <span class="font-semibold">Gold (${medals.gold.length} √ó 3pts = ${medals.gold.length * 3}pts)</span>
                                    </div>
                                    <ul class="ml-8 text-sm text-gray-600 space-y-1">
                                        ${medals.gold.map(event => `<li>‚Ä¢ ${event}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : '') +
                            (medals.silver.length > 0 ? `
                                <div class="mb-3">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-2xl">ü•à</span>
                                        <span class="font-semibold">Silver (${medals.silver.length} √ó 2pts = ${medals.silver.length * 2}pts)</span>
                                    </div>
                                    <ul class="ml-8 text-sm text-gray-600 space-y-1">
                                        ${medals.silver.map(event => `<li>‚Ä¢ ${event}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : '') +
                            (medals.bronze.length > 0 ? `
                                <div class="mb-3">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="text-2xl">ü•â</span>
                                        <span class="font-semibold">Bronze (${medals.bronze.length} √ó 1pt = ${medals.bronze.length}pts)</span>
                                    </div>
                                    <ul class="ml-8 text-sm text-gray-600 space-y-1">
                                        ${medals.bronze.map(event => `<li>‚Ä¢ ${event}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : '')
                        }
                    </div>
                    
                    <div class="border-t pt-4">
                        <h3 class="font-semibold text-gray-800 mb-3">üèÜ Your Badges (${stats.badgeCount})</h3>
                        
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            ${BADGE_DEFINITIONS.map(badge => {
                                const earned = userBadges[badge.id];
                                return `
                                    <div class="p-3 rounded-lg border-2 text-center transition-all ${
                                        earned ? 'border-yellow-400 bg-yellow-50 animate-fade-in' : 'border-gray-200 bg-gray-50 opacity-40'
                                    }">
                                        <div class="text-2xl md:text-3xl mb-1">${badge.icon}</div>
                                        <div class="font-semibold text-xs md:text-sm">${badge.name}</div>
                                        <div class="text-xs text-gray-500 mt-1">${badge.description}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

// Update time every second
setInterval(() => {
    state.currentTime = new Date();
    if (state.currentUser && state.activeTab === 'events') {
        renderTabContent();
    }
}, 1000);

// Initial load
async function initialize() {
    await loadData();
    await loadEvents();
    render();
}

initialize();

// Make functions available to the webpage buttons
window.handleSignIn = handleSignIn;
window.handleMakePick = handleMakePick;
window.render = render;
    </script>
</body>
</html>



















